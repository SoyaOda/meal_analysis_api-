================================================================================
MEAL ANALYSIS API - å®Œå…¨åˆ†æãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹é€ ã¨ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ
================================================================================
ç”Ÿæˆæ—¥æ™‚: 2025-06-05 17:23:53
åˆ†æå¯¾è±¡: /api/v1/meal-analyses/complete ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè¡Œæ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹å…¨ãƒ•ã‚¡ã‚¤ãƒ«
================================================================================

ğŸ“Š COMPLETE ANALYSIS ARCHITECTURE OVERVIEW
----------------------------------------

ğŸ”„ COMPLETE EXECUTION FLOW (4-Phase Integrated Pipeline):
Phase 1: ç”»åƒ â†’ Gemini AI â†’ æ–™ç†ãƒ»é£Ÿæè­˜åˆ¥ (è‹±èªå)
USDA Query: å…¨é£Ÿæ â†’ USDA ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç…§åˆ â†’ FDC ID å–å¾—  
Phase 2: Phase1çµæœ + USDAå€™è£œ + ç”»åƒ â†’ Gemini AI â†’ è¨ˆç®—æˆ¦ç•¥æ±ºå®šãƒ»æ „é¤Šç²¾ç·»åŒ–
Nutrition Calculation: å®Ÿé‡é‡ Ã— USDAæ „é¤Šãƒ‡ãƒ¼ã‚¿ â†’ æœ€çµ‚æ „é¤Šä¾¡è¨ˆç®—ãƒ»é›†è¨ˆ

ğŸ—ï¸ INTEGRATED LAYER STRUCTURE:
â”œâ”€â”€ FastAPI Application Layer
â”‚   â””â”€â”€ main.py (Server, routing, CORS, error handling)
â”œâ”€â”€ Complete Analysis API Layer  
â”‚   â””â”€â”€ meal_analyses_complete.py (Unified endpoint for all phases)
â”œâ”€â”€ Service Layer
â”‚   â”œâ”€â”€ gemini_service.py (Vertex AI Geminié€£æº - Phase1&2)
â”‚   â”œâ”€â”€ usda_service.py (USDA FoodData Central APIé€£æº)
â”‚   â””â”€â”€ nutrition_calculation_service.py (Nutrition computation engine)
â”œâ”€â”€ Prompt Management Layer
â”‚   â”œâ”€â”€ prompt_loader.py (Template loading & management)
â”‚   â””â”€â”€ prompt templates (Phase1&2 system/user prompts)
â””â”€â”€ Configuration Layer
    â””â”€â”€ config.py (Environment variables, settings)

ğŸ”§ COMPLETE ANALYSIS TECHNICAL FEATURES:
- ğŸ”— Unified API Endpoint (/complete): All phases in single request
- ğŸ§  AI-Driven Strategy Selection: dish_level vs ingredient_level
- ğŸ“Š 3-Tier Nutrition Aggregation: ingredient â†’ dish â†’ meal  
- ğŸ’¾ Automatic Result Saving: JSON files with analysis_id
- ğŸ” 100% USDA Integration: Real nutrition data retrieval
- âš¡ Async Processing: Non-blocking operations throughout
- ğŸ›¡ï¸ Comprehensive Error Handling: Per-phase error isolation
- ğŸ“ˆ Real-time Logging: Detailed execution tracking

ğŸ¯ KEY IMPROVEMENTS OVER PHASE-BY-PHASE APPROACH:
- Single API call instead of multiple requests
- Automatic data flow between phases  
- Integrated error handling across all phases
- Built-in result persistence and retrieval
- Optimized resource usage with service caching

================================================================================

ğŸ“ FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤
============================================================

ğŸ“„ FILE: app/main.py
--------------------------------------------------
å­˜åœ¨: âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

============================================================

ğŸ“ å®Œå…¨åˆ†æAPI ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå±¤
============================================================

ğŸ“„ FILE: app/api/v1/endpoints/meal_analyses_complete.py
--------------------------------------------------
å­˜åœ¨: âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

============================================================

ğŸ“ ã‚µãƒ¼ãƒ“ã‚¹å±¤
============================================================

ğŸ“„ FILE: app/services/gemini_service.py
--------------------------------------------------
å­˜åœ¨: âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

============================================================

ğŸ“„ FILE: app/services/usda_service.py
--------------------------------------------------
å­˜åœ¨: âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

============================================================

ğŸ“„ FILE: app/services/nutrition_calculation_service.py
--------------------------------------------------
å­˜åœ¨: âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

============================================================

ğŸ“ è¨­å®šç®¡ç†
============================================================

ğŸ“„ FILE: app/core/config.py
--------------------------------------------------
å­˜åœ¨: âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

============================================================

ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†
============================================================

ğŸ“„ FILE: app/prompts/__init__.py
--------------------------------------------------
å­˜åœ¨: âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

============================================================

ğŸ“„ FILE: app/prompts/prompt_loader.py
--------------------------------------------------
å­˜åœ¨: âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

============================================================

ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
============================================================

ğŸ“„ FILE: app/prompts/phase1_system_prompt.txt
--------------------------------------------------
å­˜åœ¨: âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

============================================================

ğŸ“„ FILE: app/prompts/phase1_user_prompt_template.txt
--------------------------------------------------
å­˜åœ¨: âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

============================================================

ğŸ“„ FILE: app/prompts/phase2_system_prompt.txt
--------------------------------------------------
å­˜åœ¨: âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

============================================================

ğŸ“„ FILE: app/prompts/phase2_user_prompt_template.txt
--------------------------------------------------
å­˜åœ¨: âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

============================================================

ğŸ“ ãƒ†ã‚¹ãƒˆãƒ»å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«
============================================================

ğŸ“„ FILE: test_complete_analysis.py
--------------------------------------------------
ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: 6,035 bytes
æœ€çµ‚æ›´æ–°: 2025-06-05 10:49:36
å­˜åœ¨: âœ…

CONTENT:
```
import requests
import json
import asyncio
from pathlib import Path

# APIè¨­å®š
BASE_URL = "http://localhost:8000/api/v1"

# ãƒ†ã‚¹ãƒˆç”»åƒã®ãƒ‘ã‚¹
image_path = "test_images/food3.jpg"

def test_complete_analysis():
    """å®Œå…¨åˆ†æã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ"""
    
    print("=== Complete Meal Analysis Test ===")
    print(f"Using image: {image_path}")
    
    try:
        # å®Œå…¨åˆ†æã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—
        with open(image_path, "rb") as f:
            files = {"image": ("food3.jpg", f, "image/jpeg")}
            data = {"save_results": True}  # çµæœã‚’ä¿å­˜
            
            print("Starting complete analysis pipeline...")
            response = requests.post(f"{BASE_URL}/meal-analyses/complete", files=files, data=data)
        
        print(f"Status Code: {response.status_code}")
        
        if response.status_code == 200:
            result = response.json()
            print("âœ… Complete analysis successful!")
            
            # åˆ†æID
            analysis_id = result.get("analysis_id")
            print(f"Analysis ID: {analysis_id}")
            
            # å‡¦ç†ã‚µãƒãƒªãƒ¼
            summary = result.get("processing_summary", {})
            print(f"\nğŸ“Š Processing Summary:")
            print(f"- Total dishes: {summary.get('total_dishes')}")
            print(f"- Total ingredients: {summary.get('total_ingredients')}")
            print(f"- USDA match rate: {summary.get('usda_match_rate')}")
            print(f"- Total calories: {summary.get('total_calories')} kcal")
            print(f"- Pipeline status: {summary.get('pipeline_status')}")
            
            # ä¿å­˜å…ˆ
            saved_to = result.get("saved_to")
            if saved_to:
                print(f"- Results saved to: {saved_to}")
            
            # æœ€çµ‚æ „é¤Šä¾¡çµæœ
            final_nutrition = result.get("final_nutrition_result", {})
            total_nutrients = final_nutrition.get("total_meal_nutrients", {})
            
            print(f"\nğŸ½ Final Meal Nutrition:")
            print(f"- Calories: {total_nutrients.get('calories_kcal', 0):.2f} kcal")
            print(f"- Protein: {total_nutrients.get('protein_g', 0):.2f} g")
            print(f"- Carbohydrates: {total_nutrients.get('carbohydrates_g', 0):.2f} g")
            print(f"- Fat: {total_nutrients.get('fat_g', 0):.2f} g")
            
            # å„ãƒ•ã‚§ãƒ¼ã‚ºã®çµæœæ•°
            phase1_dishes = len(result.get("phase1_result", {}).get("dishes", []))
            phase2_dishes = len(result.get("phase2_result", {}).get("dishes", []))
            final_dishes = len(final_nutrition.get("dishes", []))
            
            print(f"\nğŸ“ˆ Pipeline Progress:")
            print(f"- Phase 1 dishes: {phase1_dishes}")
            print(f"- Phase 2 dishes: {phase2_dishes}")
            print(f"- Final dishes: {final_dishes}")
            print(f"- USDA matches: {result.get('usda_matches_count', 0)}")
            
            return True, analysis_id
            
        else:
            print("âŒ Complete analysis failed!")
            print(f"Error: {response.text}")
            return False, None
            
    except Exception as e:
        print(f"âŒ Error during complete analysis: {e}")
        return False, None

def test_list_results():
    """ä¿å­˜ã•ã‚ŒãŸçµæœã®ä¸€è¦§ã‚’å–å¾—"""
    
    print("\n=== List Saved Results ===")
    
    try:
        response = requests.get(f"{BASE_URL}/meal-analyses/results")
        
        if response.status_code == 200:
            results = response.json()
            total = results.get("total_results", 0)
            print(f"ğŸ“ Total saved results: {total}")
            
            if total > 0:
                print("\nRecent results:")
                for i, result in enumerate(results.get("results", [])[:5]):  # æœ€æ–°5ä»¶
                    print(f"{i+1}. {result.get('filename')}")
                    print(f"   ID: {result.get('analysis_id')}")
                    print(f"   Time: {result.get('timestamp')}")
                    summary = result.get('summary', {})
                    print(f"   Calories: {summary.get('total_calories', 0)} kcal")
                    print()
            
        else:
            print(f"âŒ Failed to list results: {response.status_code}")
            
    except Exception as e:
        print(f"âŒ Error listing results: {e}")

def test_get_specific_result(analysis_id):
    """ç‰¹å®šã®åˆ†æçµæœã‚’å–å¾—"""
    
    if not analysis_id:
        return
        
    print(f"\n=== Get Specific Result: {analysis_id} ===")
    
    try:
        response = requests.get(f"{BASE_URL}/meal-analyses/results/{analysis_id}")
        
        if response.status_code == 200:
            result = response.json()
            print(f"âœ… Retrieved result for analysis ID: {analysis_id}")
            
            # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
            metadata = result.get("metadata", {})
            print(f"Timestamp: {metadata.get('timestamp')}")
            print(f"Pipeline: {metadata.get('processing_pipeline')}")
            
            # å‡¦ç†ã‚µãƒãƒªãƒ¼
            summary = result.get("processing_summary", {})
            print(f"Status: {summary.get('pipeline_status')}")
            print(f"Total calories: {summary.get('total_calories')} kcal")
            
        else:
            print(f"âŒ Failed to get result: {response.status_code}")
            
    except Exception as e:
        print(f"âŒ Error getting specific result: {e}")

if __name__ == "__main__":
    print("Testing Complete Meal Analysis Pipeline")
    print("=" * 50)
    
    # å®Œå…¨åˆ†æã®ãƒ†ã‚¹ãƒˆ
    success, analysis_id = test_complete_analysis()
    
    if success:
        # çµæœä¸€è¦§ã®ãƒ†ã‚¹ãƒˆ
        test_list_results()
        
        # ç‰¹å®šçµæœå–å¾—ã®ãƒ†ã‚¹ãƒˆ
        test_get_specific_result(analysis_id)
        
        print("\nğŸ‰ All tests completed!")
    else:
        print("\nğŸ’¥ Complete analysis test failed!") 
```

============================================================

ğŸ¯ COMPLETE ANALYSIS SUMMARY
----------------------------------------
ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 13
å­˜åœ¨ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 1
åˆ†æå®Œäº†æ™‚åˆ»: 2025-06-05 17:23:53

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€/api/v1/meal-analyses/complete ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
å®Ÿè¡Œæ™‚ã«é–¢ã‚ã‚‹å®Œå…¨åˆ†æãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å…¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®
å®Œå…¨ãªå†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ğŸ”¥ COMPLETE ANALYSIS FEATURES:
- Phase 1: Gemini AI image analysis
- USDA Query: Database ingredient matching  
- Phase 2: Strategy determination & refinement
- Nutrition Calculation: Weight-based macro computation
- Result Management: Automatic save/retrieve functionality
